-- 進行可能申請一覧検索用SQL
-- ユーザが割り当てられているアクティブタスクに対してワークアイテムを結合したビューを紐付ける。
SELECT_ACTIVE_APPLICATION_BY_CONDITION=
SELECT
    WORK_ITEM.BUSINESS_TYPE,
    WORK_ITEM.APPLICATION_ID,
    WORK_ITEM.APPLICATION_DATE,
    USERS.KANJI_NAME APPLICATION_USER_NAME,
    WORK_ITEM.STATUS_CD
FROM
    (
    SELECT  -- 交通費申請
        TRANS_EXPE_APPLICATION.WF_INSTANCE_ID,
        '2' BUSINESS_TYPE,
        TRANS_EXPE_APPLICATION.TRANS_EXPE_APPLI_ID APPLICATION_ID,
        TRANS_EXPE_APPLICATION.INSERT_DATE_TIME APPLICATION_DATE,
        TRANS_EXPE_APPLICATION.INSERT_USER_ID APPLICATION_USER_ID,
        TRANS_EXPE_APPLICATION.TRANS_EXPE_APPLI_STATUS_CD STATUS_CD
    FROM
        TRANS_EXPE_APPLICATION
    INNER JOIN
      (
      SELECT    -- アクティブユーザタスク
          WF_ACTIVE_USER_TASK.INSTANCE_ID,
          WF_ACTIVE_USER_TASK.FLOW_NODE_ID
      FROM
          WF_ACTIVE_USER_TASK
      WHERE
          WF_ACTIVE_USER_TASK.ASSIGNED_USER_ID = :loginUserId
      UNION ALL
      SELECT    -- アクティブグループタスク
          WF_ACTIVE_GROUP_TASK.INSTANCE_ID,
          WF_ACTIVE_GROUP_TASK.FLOW_NODE_ID
      FROM
          WF_ACTIVE_GROUP_TASK
      WHERE
          WF_ACTIVE_GROUP_TASK.ASSIGNED_GROUP_ID = :ugroupId
      ) ACTIVE_TASK
    ON
        TRANS_EXPE_APPLICATION.WF_INSTANCE_ID = ACTIVE_TASK.INSTANCE_ID
    UNION ALL
    SELECT  -- ローン申請
        LOAN_APPLICATION.WF_INSTANCE_ID,
        '1',
        LOAN_APPLICATION.LOAN_APPLI_ID,
        LOAN_APPLICATION.INSERT_DATE_TIME,
        LOAN_APPLICATION.INSERT_USER_ID,
        LOAN_APPLICATION.LOAN_APPLI_STATUS_CD
    FROM
        LOAN_APPLICATION
    INNER JOIN
    (
    SELECT    -- アクティブユーザタスク
        WF_ACTIVE_USER_TASK.INSTANCE_ID,
        WF_ACTIVE_USER_TASK.FLOW_NODE_ID
    FROM
        WF_ACTIVE_USER_TASK
    WHERE
        WF_ACTIVE_USER_TASK.ASSIGNED_USER_ID = :loginUserId
    UNION ALL
    SELECT    -- アクティブグループタスク
        WF_ACTIVE_GROUP_TASK.INSTANCE_ID,
        WF_ACTIVE_GROUP_TASK.FLOW_NODE_ID
    FROM
        WF_ACTIVE_GROUP_TASK
    WHERE
        WF_ACTIVE_GROUP_TASK.ASSIGNED_GROUP_ID = :ugroupId
    ) ACTIVE_TASK
    ON
        LOAN_APPLICATION.WF_INSTANCE_ID = ACTIVE_TASK.INSTANCE_ID
    ) WORK_ITEM
INNER JOIN
    USERS
ON
    WORK_ITEM.APPLICATION_USER_ID = USERS.USER_ID
WHERE
    $if(businessType) {WORK_ITEM.BUSINESS_TYPE = :businessType}
    AND $if(applicationUserId) {WORK_ITEM.APPLICATION_USER_ID = :applicationUserId}
ORDER BY
    WORK_ITEM.APPLICATION_DATE